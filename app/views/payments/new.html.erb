<div class="signup">
  <header class="int-header">
    <%= render :partial => "pages/partials/menu"%>
    <%= render :partial => "pages/partials/page_banner", :locals => { :header => "Payment"}%>
  </header>
  <%total = 0.0%>
  <%= form_for @payment, :html =>{:class=>"payment ", :id=>"checkout-form"} do |f|  %>

      <div class="row">
        <div class="small-12 columns">
          <div class="goback">
            <a href="/add-ons<%="?plan="+ @product.slug if @product%>">Go back</a>
          </div>
        </div>
      </div>
      <div class="form-step step3">

        <div class="row">
          <div class="small-12 columns">
            <table cellpadding="0" cellspacing="0">
              <tr>
                <th class="">Plan</th>
                <th></th>
                <th class="removecolumn"></th>
                <th class="price">Price</th>
              </tr>
              <%if @product%>
                  <tr id="checkout-item-1">
                    <td class="">
                      <%=@product.name.split(' ')[0]%> Plan
                    </td>
                    <td>
                      <select name="payment_option" id="payment-option" onchange="updatePackage()">
                        <option value="<%=@product.slug%>" selected>Pay Annually ($<%=(@product.price/12).to_i %> x 12/mo) - save 20%</option>
                        <option value="<%=@product.monthly_package.slug%>">Pay Monthly</option>
                      </select>
                    </td>
                    <%total = @product.price%>
                    <input type="hidden" id="<%=@product.slug%>" value="<%=@product.price%>"/>
                    <input type="hidden" id="<%=@product.monthly_package.slug%>" value="<%=@product.monthly_package.price%>"/>

                    <input type="hidden" id="nbd-<%=@product.slug%>" value="<%=Date.today + @product.interval.days%>"/>
                    <input type="hidden" id="nbd-<%=@product.monthly_package.slug%>" value="<%=Date.today+ @product.monthly_package.interval.days%>"/>

                    <td class="remove">
                      <!--<a class="remove" data-remove="checkout-item-1">remove</a>-->
                    </td>
                    <td class="price" id="price-sub">
                      $<%=(@product.price) %>
                    </td>
                  </tr>
              <%end%>
              <% addons_price = 0.0 %>
              <%@add_ons.each do |a|%>
                  <tr id="checkout-item-<%=a.id%>">
                    <input type="hidden" name="add_ons[<%=a.id%>]" value="<%=@add_on_hash["#{a.id}"]%>"/>
                    <td class="">
                      <%=a.name%> (<%=@add_on_hash["#{a.id}"]%>)
                    </td>
                    <td>
                    </td>
                    <td class="remove">
                      <a data-remove="checkout-item-<%=a.id%>" class="remove" onclick="removeAddonCost(<%=a.price * @add_on_hash["#{a.id}"].to_f%>)">remove</a>
                    </td>
                    <td class="price">
                      $<%=price = a.price * @add_on_hash["#{a.id}"].to_f%>
                    </td>
                  </tr>
                  <%total += price %>
                  <%addons_price += price %>
              <%end if @add_ons.present?%>
              <input type="hidden" id="addons-price" value="<%=addons_price%>"/>
              <tr class="totals">
                <td class="">
                  TOTAL
                </td>
                <td>
                </td>
                <td>
                </td>
                <td class="price" id="price-total">$<%=total%></td>
              </tr>
            </table>
          </div>
        </div>

        <%if @product.present?%>
            <div class="row">
              <div class="hide-for-small medium-7 columns"> &nbsp;
              </div>
              <div class="small-12 medium-3 columns">
                <label>
                  <input type="text" placeholder="Promo Code" name="code" id="promo_code" autocomplete="off" aria-invalid="false" value="<%=@discount.code if @discount.present?%>">
                </label>
              </div>

              <div class="small-12 medium-2 columns">
                <label>
                  <input type="button" value="Apply Code" onclick="applyDiscount();" name="update">
                </label>
              </div>

              <div class="small-5 columns right">
                <p id="discount_response" style="margin-top:0px;"></p>
              </div>
            </div>
        <%end%>
        <input type="hidden" id="discount-amount" value="0"/>
        <div class="alert alert-danger">
          <ul style="list-style:none;text-align:center;">
            <%flash[:errors].each do |e|%>
                <li><%=e%></li>
            <%end if flash[:errors].present?%>
          </ul>
        </div>
        <div class="signup-footer ftform" id="checkoutdata">
          <div class="row">
            <div class="small-12 columns">
              <h3>Payment Information</h3>
            </div>
          </div>
          <input type="hidden" value="<%=@product.try(:slug) || "add-on"%>" name="slug" id="slug"/>
          <div class="row">
            <div class="small-2 medium-2 large-2 columns custom-padding">
              <label>Title
                <%=select "contact", "title", [["Mr", 'Mr'], ["Ms", 'Ms'], ["Mrs", 'Mrs']], {}, {:class => "select-checkout"} %>
              </label>
            </div>

            <div class="small-10 medium-5 large-5 columns custom-padding">
              <label>First Name
                <%=text_field "contact", "first_name" ,:value=>current_user.first_name, :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "First name can't be blank"%>
              </label>
            </div>

            <div class="small-12 medium-5 large-5 columns custom-padding">
              <label>Last Name
                <%=text_field "contact", "last_name" , :value=>current_user.last_name, :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "Last name can't be blank" %>
              </label>
            </div>
          </div>

          <div class="row">
            <div class="small-12 columns custom-padding">
              <label>Phone
                <%=text_field "contact", "phone" , :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "Phone can't be blank","data-validation"=>"number" %>
              </label>
            </div>
          </div>

          <div class="row">
            <div class="small-12 medium-6 large-8 columns custom-padding">
              <label>Address
                <%=text_field "contact", "address1" , :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "Address can't be blank" %>
              </label>
            </div>

            <div class="small-12 medium-6 large-4 columns custom-padding">
              <label>City
                <%=text_field "contact", "city" , :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "City can't be blank"
                %>
              </label>
            </div>
          </div>

          <div class="row">
            <div class="small-12 medium-4 large-4 columns custom-padding">
              <label>State
                <%=text_field "contact", "state" , :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "State can't be blank",:placeholder => "NY" %>
              </label>
            </div>

            <div class="small-12 medium-4 large-3 columns custom-padding">
              <label>Postal Code
                <%=text_field "contact", "zip" , :class=>"form-control","data-validation"=>"required",
                              "data-validation-error-msg"=> "Postal Code/Zip can't be blank" %>
              </label>
            </div>

            <div class="small-12 medium-4 large-5 columns custom-padding">
              <label>Country
                <%=select_tag "contact[country]",options_for_select(Country.all.sort),{:class=>"select-checkout"}%>
              </label>
            </div>
          </div>



          <div class="row">
            <div class="small-12 medium-12 large-4 columns custom-padding">
              <label>Credit Card Type
                <%=select "card", "credit_card_type", [["Visa", 'visa'], ["Master Card", 'mastercard'],["American Express", 'amex'],["Discover", 'discover'],["JCB","jcb"] ], {}, {:class => "select-checkout"} %>
              </label>
            </div>

            <div class="small-8 medium-8 large-5 columns custom-padding">
              <label>Credit Card Number
                <%=text_field "card", "credit_card_number" , :class=>"form-control", :autocomplete=>"off" , "data-bluesnap"=>"encryptedCreditCard","data-validation"=>"required",
                              "data-validation-error-msg"=> "Card number can't be blank","data-validation"=>"number" %>
              </label>
            </div>

            <div class="small-4 medium-4 large-3 columns custom-padding">
              <label>CVV
                <%=password_field "card", "verification_code", :maxlength=> "4", :class=>"form-control", :autocomplete=>"off", "data-bluesnap" =>"encryptedCvv",
                              "data-validation"=>"length", "data-validation-length"=>"min2",
                              "data-validation-error-msg"=> "CVV must be greater then 2 characters","data-validation"=>"number"%>
              </label>
            </div>


          </div>
          <div class="row">
            <div class="small-6 medium-6 large-3 columns custom-padding">
              <label>Exp. Month
                <%=text_field "card", "expiration_month", :class=>"form-control", :autocomplete=>"off",:placeholder=>"04","data-validation"=>"required",
                              "data-validation-error-msg"=> "Expiry Month can't be blank","data-validation"=>"number"  %>
              </label>
            </div>
            <div class="small-6 medium-6 large-3 columns left custom-padding">
              <label>Exp. Year
                <%=text_field "card", "expiration_year", :class=>"form-control", :autocomplete=>"off",:placeholder=>"2015","data-validation"=>"required",
                              "data-validation-error-msg"=> "Expiry Year can't be blank and must be in YYYY format", "data-validation"=>"length" , "data-validation-length"=>"4-4"%>
              </label>
            </div>
          </div>

          <div class="row formdisclaimers">
            <div class="small-12 columns">
              <p><strong>Robin8 accepts Visa, Mastercard, Discover and American Express. </strong><br /> By joining Robin8 you are agreeing to the <a href="terms.html">Terms of Use</a> and Privacy Policy. To ensure continued service, your membership will be auto-renewed unless canceled. Satisfaction guaranteed or your money back (within 30 days). <br />All prices in US Dollars.</p>

              <%if @product.present?%>
                  <p class="chargesummary">Today your charge will be <span class="chargetotal" id = "t-price">$<%=total%></span> and your next bill date will be <span class="chargedate" id = "next-date"><%=Date.today + @product.try(:interval).to_i.days %></span></p>
              <%end%>
            </div>
          </div>
          <div class="row">
            <div class="small-12 columns">
              <div class="submit-wrap">
                <%= submit_tag "SUBMIT", :class=>"button button-signup nextstep" %>
              </div>
            </div>
          </div>
        </div>
      </div>
  <%end%>
  <div class="clearfix"></div>
  <style>
      .ui-selectmenu-button {
          margin-top:10px;
      }
      .ui-selectmenu-menu .ui-menu{
          max-height: 200px;
      }

      .signup-footer.ftform .ui-selectmenu-button {
          background: none repeat scroll 0 0 transparent;
          border: 1px solid #ffffff;
          color: #ffffff;
          height: 40px!important;
          margin-top: 10px;
      }
      .form-error{
          font-size: 15px;
          color: #FF0000;
          vertical-align:top;
      }


      .signup form .signup-footer.ftform label input {
          margin-bottom: 5px;
      }
      .custom-padding {
          margin-bottom: 25px;
      }


  </style>

  <script src="https://gateway.bluesnap.com/js/cse/v1.0.1/bluesnap.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.1.47/jquery.form-validator.min.js"></script>

  <script>
      $.validate();
      <%if @discount.present?%>
      applyDiscount();
      <%end%>

      function updatePackage(){
        $('#slug').val($('#payment-option').val());
        productCost = parseInt($("#"+$('#slug').val()).val());
        $('#price-sub').html('$'+(productCost));
        $('#next-date').html($('#nbd-'+$('#slug').val()).val() );
        updateTotal();
        applyDiscount();
      }

      function applyDiscount(){
        if($("#promo_code").val()!=''){
          $.ajax({
            url: "/payments/apply_discount?code="+$("#promo_code").val()+"&product_slug="+$('#slug').val()
          })
            .done(function( discountAmount ) {
              if ( discountAmount != '' ) {
                $('#discount-amount').val(discountAmount);
                updateTotal();
                productCost = parseInt($("#"+$('#slug').val()).val());
                $('#price-sub').html('$'+parseInt((productCost - parseInt(discountAmount))));
                $('#discount_response').html("Discount successfully applied to your account");
                $('#discount_response').css("color","#02BA64");
              } else {
                $('#discount_response').html("Discount code is not valid or expired");
                $('#discount_response').css("color","#FF6301");
              }
          });
        }
      }

      function removeAddonCost(amount){
        if ($('#addons-price').length) {
          addonsCost = parseInt($('#addons-price').val());
          $('#addons-price').html( addonsCost - amount );
        }

        if ($('#price-total').length) {
          addonsCost = parseInt($('#price-total').html().slice(1));
          $('#price-total').html( '$' + (addonsCost - amount).toString());
        }

        return true
      }

      function updateTotal() {
        productCost    = parseInt($("#"+$('#slug').val()).val());
        discountAmount = parseInt($('#discount-amount').val());
        addonsCost     = parseInt($('#addons-price').val());
        total = productCost - discountAmount + addonsCost
        $('#total').val(total);
        $('#price-total').html('$'+ total);
        $('#t-price').html('$'+ total);
        return true
      }

      $(document).ready(function(){
          if( !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
              $( ".select-checkout" ).selectmenu();
          }
      });

      BlueSnap.publicKey = '<%=Rails.application.secrets[:bluesnap][:public_key]%>';
      BlueSnap.setTargetFormId("checkout-form");

  </script>
</div>
